// ===== TRANSLATIONS =====
const translations = {
  en: {
    appName: "Tamrini",
    welcome: "Welcome to Tamrini!",
    welcomeDesc: "I'll help you understand math step by step. No direct answers ‚Äî just fun learning!",
    mascotSpeech: "Hi there! Ready to learn some math today? üéâ",
    startBtn: "START LEARNING",
    placeholder: "Type your question...",
    inputHint: "Press Enter to send üí¨",
    greeting: "Hey there! üëã I'm Tamrini, your math buddy!\n\nI won't just give you answers ‚Äî that's no fun! Instead, I'll help you figure things out step by step.\n\nSo, what math problem are you working on? üßÆ",
    online: "Online",
    progress: "Keep going! üí™",
    error: "Oops! Let's try that again üòÖ",
    quotaError: "Whoa! Too fast! Take a breath and try again üßò",
  },
  fr: {
    appName: "Tamrini",
    welcome: "Bienvenue sur Tamrini!",
    welcomeDesc: "Je t'aide √† comprendre les maths √©tape par √©tape. Pas de r√©ponses directes ‚Äî juste du fun!",
    mascotSpeech: "Salut! Pr√™t √† apprendre des maths aujourd'hui? üéâ",
    startBtn: "COMMENCER",
    placeholder: "√âcris ta question...",
    inputHint: "Appuie sur Entr√©e pour envoyer üí¨",
    greeting: "Salut! üëã Je suis Tamrini, ton ami des maths!\n\nJe ne vais pas te donner les r√©ponses directement ‚Äî c'est pas marrant! Je vais t'aider √† comprendre √©tape par √©tape.\n\nAlors, sur quel probl√®me tu travailles? üßÆ",
    online: "En ligne",
    progress: "Continue! üí™",
    error: "Oups! R√©essayons üòÖ",
    quotaError: "Doucement! Trop rapide! Respire et r√©essaie üßò",
  },
  ar: {
    appName: "ÿ™ŸÖÿ±ŸäŸÜŸä",
    welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿ™ŸÖÿ±ŸäŸÜŸä!",
    welcomeDesc: "ÿ≥ÿ£ÿ≥ÿßÿπÿØŸÉ ÿπŸÑŸâ ŸÅŸáŸÖ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©. ŸÑÿß ÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ‚Äî ŸÅŸÇÿ∑ ÿ™ÿπŸÑŸÖ ŸÖŸÖÿ™ÿπ!",
    mascotSpeech: "ŸÖÿ±ÿ≠ÿ®ÿßŸã! ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑÿ™ÿπŸÑŸÖ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™ ÿßŸÑŸäŸàŸÖÿü üéâ",
    startBtn: "ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿπŸÑŸÖ",
    placeholder: "ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ...",
    inputHint: "ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ üí¨",
    greeting: "ŸÖÿ±ÿ≠ÿ®ÿßŸã! üëã ÿ£ŸÜÿß ÿ™ŸÖÿ±ŸäŸÜŸäÿå ÿµÿØŸäŸÇŸÉ ŸÅŸä ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™!\n\nŸÑŸÜ ÿ£ÿπÿ∑ŸäŸÉ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ‚Äî Ÿáÿ∞ÿß ŸÑŸäÿ≥ ŸÖŸÖÿ™ÿπÿßŸã! ÿ≥ÿ£ÿ≥ÿßÿπÿØŸÉ ÿπŸÑŸâ ÿßŸÑŸÅŸáŸÖ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©.\n\nÿ•ÿ∞ŸÜÿå ŸÖÿß ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ© ÿßŸÑÿ™Ÿä ÿ™ÿπŸÖŸÑ ÿπŸÑŸäŸáÿßÿü üßÆ",
    online: "ŸÖÿ™ÿµŸÑ",
    progress: "ÿßÿ≥ÿ™ŸÖÿ±! üí™",
    error: "ÿπÿ∞ÿ±ÿßŸã! ŸÑŸÜÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ üòÖ",
    quotaError: "ŸÖŸáŸÑÿßŸã! ÿ®ÿ∑Ÿëÿ¶ ŸÇŸÑŸäŸÑÿßŸã! ÿÆÿ∞ ŸÜŸÅÿ≥ÿßŸã Ÿàÿ≠ÿßŸàŸÑ ŸÖÿ¨ÿØÿØÿßŸã üßò",
  }
};

// ===== STATE =====
let currentLang = localStorage.getItem('tamrini_lang') || 'en';
let messages = [];
let isLoading = false;
let messageCount = 0;

const API_URL = 'https://tamarini-app.vercel.app/api/chat';

// ===== ELEMENTS =====
const $ = id => document.getElementById(id);

// ===== INIT =====
function init() {
  // Hide splash
  setTimeout(() => {
    $('splash').classList.add('hidden');
    $('home-screen').classList.add('active');
  }, 2000);

  updateLanguage(currentLang);
  setupEventListeners();
}

// ===== LANGUAGE =====
function updateLanguage(lang) {
  currentLang = lang;
  localStorage.setItem('tamrini_lang', lang);
  
  const t = translations[lang];
  
  // Update text
  $('welcome-title').textContent = t.welcome;
  $('welcome-desc').textContent = t.welcomeDesc;
  $('mascot-speech').textContent = t.mascotSpeech;
  $('start-text').textContent = t.startBtn;
  $('chat-title').textContent = t.appName;
  $('status-text').textContent = t.online;
  $('message-input').placeholder = t.placeholder;
  $('input-hint').textContent = t.inputHint;
  $('progress-text').textContent = t.progress;
  
  // Update lang buttons
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === lang);
  });
  
  // RTL
  document.body.classList.toggle('rtl', lang === 'ar');
}

// ===== EVENT LISTENERS =====
function setupEventListeners() {
  // Language buttons
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.addEventListener('click', () => updateLanguage(btn.dataset.lang));
  });

  // Start button
  $('start-btn').addEventListener('click', () => {
    $('home-screen').classList.remove('active');
    $('chat-screen').classList.add('active');
    
    if (messages.length === 0) {
      addMessage('bot', translations[currentLang].greeting);
    }
    
    $('message-input').focus();
  });

  // Back button
  $('back-btn').addEventListener('click', () => {
    $('chat-screen').classList.remove('active');
    $('home-screen').classList.add('active');
  });

  // Input
  const input = $('message-input');
  const sendBtn = $('send-btn');
  
  input.addEventListener('input', () => {
    sendBtn.disabled = !input.value.trim() || isLoading;
    autoResize(input);
  });

  // Send
  sendBtn.addEventListener('click', sendMessage);
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Error close
  $('error-close').addEventListener('click', () => {
    $('error').classList.add('hidden');
  });
}

// ===== AUTO RESIZE =====
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

// ===== ADD MESSAGE =====
function addMessage(role, content) {
  messages.push({ role, content });
  
  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const name = role === 'bot' ? 'Tamrini' : 'You';
  const avatar = role === 'bot' ? 'üìê' : 'üòä';
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${role === 'user' ? 'user' : 'bot'}`;
  
  messageDiv.innerHTML = `
    <div class="message-avatar">${avatar}</div>
    <div class="message-content">
      <div class="message-name">${name}</div>
      <div class="message-text">${formatMessage(content)}</div>
      <div class="message-time">${time}</div>
    </div>
  `;
  
  $('messages').appendChild(messageDiv);
  scrollToBottom();
  
  // Update progress
  if (role === 'user') {
    messageCount++;
    updateProgress();
  }
}

// ===== FORMAT MESSAGE =====
function formatMessage(text) {
  return text
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

// ===== UPDATE PROGRESS =====
function updateProgress() {
  const progress = Math.min(messageCount * 10, 100);
  $('progress-fill').style.width = progress + '%';
  
  const messages = ['Keep going! üí™', 'Great job! üåü', 'You\'re doing amazing! üöÄ', 'Math champion! üèÜ'];
  const index = Math.min(Math.floor(messageCount / 3), messages.length - 1);
  $('progress-text').textContent = messages[index];
}

// ===== SCROLL =====
function scrollToBottom() {
  const container = $('messages');
  container.scrollTop = container.scrollHeight;
}

// ===== SEND MESSAGE =====
async function sendMessage() {
  const input = $('message-input');
  const text = input.value.trim();
  
  if (!text || isLoading) return;

  // Add user message
  addMessage('user', text);
  input.value = '';
  input.style.height = 'auto';
  $('send-btn').disabled = true;

  // Show typing
  isLoading = true;
  $('typing').classList.remove('hidden');
  $('error').classList.add('hidden');
  scrollToBottom();

  try {
    const history = messages.slice(-10).map(m => ({
      role: m.role === 'bot' ? 'assistant' : m.role,
      content: m.content
    }));

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: text,
        language: currentLang,
        history
      })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.details?.includes('quota') ? 'QUOTA' : 'ERROR');
    }

    // Show celebration on first message
    if (messageCount === 1) {
      showCelebration();
    }

    addMessage('bot', data.reply);

  } catch (error) {
    const t = translations[currentLang];
    $('error-text').textContent = error.message === 'QUOTA' ? t.quotaError : t.error;
    $('error').classList.remove('hidden');
  }

  isLoading = false;
  $('typing').classList.add('hidden');
}

// ===== CELEBRATION =====
function showCelebration() {
  const celebration = $('celebration');
  celebration.classList.remove('hidden');
  
  setTimeout(() => {
    celebration.classList.add('hidden');
  }, 2000);
}

// ===== START =====
document.addEventListener('DOMContentLoaded', init);
